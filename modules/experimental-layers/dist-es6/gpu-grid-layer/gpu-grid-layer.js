// Copyright (c) 2015 - 2017 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
import { CompositeLayer } from '@deck.gl/core';
import GPUGridCellLayer from './gpu-grid-cell-layer';
import { pointToDensityGridData } from './gpu-grid-utils';
import GPUGridAggregator from '@deck.gl/experimental-layers/utils/gpu-grid-aggregator';
const MINCOLOR = [0, 0, 0, 255];
const CPU_MAXCOLOR = [255, 0, 0, 255];
const GPU_MAXCOLOR = [0, 255, 0, 255];
const defaultProps = {
  // elevation
  elevationScale: 1,
  // grid
  cellSize: {
    type: 'number',
    min: 0,
    max: 1000,
    value: 1000
  },
  coverage: {
    type: 'number',
    min: 0,
    max: 1,
    value: 1
  },
  getPosition: x => x.position,
  extruded: false,
  fp64: false,
  pickable: false,
  // TODO: Enable picking with GPU Aggregation
  // Optional settings for 'lighting' shader module
  lightSettings: {},
  // GPU Aggregation
  gpuAggregation: true
};
export default class GPUGridLayer extends CompositeLayer {
  initializeState() {
    const gl = this.context.gl;
    const options = {
      id: `${this.id}-gpu-aggregator`,
      shaderCache: this.context.shaderCache
    };
    this.state = {
      gpuGridAggregator: new GPUGridAggregator(gl, options)
    };
  }

  updateState({
    oldProps,
    props,
    changeFlags
  }) {
    const reprojectNeeded = this.needsReProjectPoints(oldProps, props);

    if (changeFlags.dataChanged || reprojectNeeded) {
      // project data into hexagons, and get sortedBins
      this.getLayerData();
    }
  }

  needsReProjectPoints(oldProps, props) {
    return oldProps.cellSize !== props.cellSize || oldProps.gpuAggregation !== props.gpuAggregation || oldProps.getPosition !== props.getPosition;
  }

  getLayerData() {
    const _this$props = this.props,
          data = _this$props.data,
          cellSize = _this$props.cellSize,
          getPosition = _this$props.getPosition,
          gpuAggregation = _this$props.gpuAggregation;

    const _pointToDensityGridDa = pointToDensityGridData({
      data,
      cellSizeMeters: cellSize,
      getPosition,
      gpuAggregation,
      gpuGridAggregator: this.state.gpuGridAggregator
    }),
          countsBuffer = _pointToDensityGridDa.countsBuffer,
          maxCountBuffer = _pointToDensityGridDa.maxCountBuffer,
          gridSize = _pointToDensityGridDa.gridSize,
          gridOrigin = _pointToDensityGridDa.gridOrigin,
          gridOffset = _pointToDensityGridDa.gridOffset;

    this.setState({
      countsBuffer,
      maxCountBuffer,
      gridSize,
      gridOrigin,
      gridOffset
    });
  } // for subclassing, override this method to return
  // customized sub layer props


  getSubLayerProps() {
    const _this$props2 = this.props,
          elevationScale = _this$props2.elevationScale,
          fp64 = _this$props2.fp64,
          extruded = _this$props2.extruded,
          cellSize = _this$props2.cellSize,
          coverage = _this$props2.coverage,
          lightSettings = _this$props2.lightSettings;
    const _this$state = this.state,
          countsBuffer = _this$state.countsBuffer,
          maxCountBuffer = _this$state.maxCountBuffer,
          gridSize = _this$state.gridSize,
          gridOrigin = _this$state.gridOrigin,
          gridOffset = _this$state.gridOffset;
    const minColor = MINCOLOR;
    const maxColor = this.props.gpuAggregation ? GPU_MAXCOLOR : CPU_MAXCOLOR; // return props to the sublayer constructor

    return super.getSubLayerProps({
      id: 'grid-cell',
      data: this.state.layerData,
      countsBuffer,
      maxCountBuffer,
      gridSize,
      gridOrigin,
      gridOffset,
      numInstances: gridSize[0] * gridSize[1],
      minColor,
      maxColor,
      fp64,
      cellSize,
      coverage,
      lightSettings,
      elevationScale,
      extruded,
      pickable: false
    });
  } // for subclassing, override this method to return
  // customized sub layer class


  getSubLayerClass() {
    return GPUGridCellLayer;
  }

  renderLayers() {
    const SubLayerClass = this.getSubLayerClass();
    return new SubLayerClass(this.getSubLayerProps());
  }

}
GPUGridLayer.layerName = 'GridLayer';
GPUGridLayer.defaultProps = defaultProps;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ncHUtZ3JpZC1sYXllci9ncHUtZ3JpZC1sYXllci5qcyJdLCJuYW1lcyI6WyJDb21wb3NpdGVMYXllciIsIkdQVUdyaWRDZWxsTGF5ZXIiLCJwb2ludFRvRGVuc2l0eUdyaWREYXRhIiwiR1BVR3JpZEFnZ3JlZ2F0b3IiLCJNSU5DT0xPUiIsIkNQVV9NQVhDT0xPUiIsIkdQVV9NQVhDT0xPUiIsImRlZmF1bHRQcm9wcyIsImVsZXZhdGlvblNjYWxlIiwiY2VsbFNpemUiLCJ0eXBlIiwibWluIiwibWF4IiwidmFsdWUiLCJjb3ZlcmFnZSIsImdldFBvc2l0aW9uIiwieCIsInBvc2l0aW9uIiwiZXh0cnVkZWQiLCJmcDY0IiwicGlja2FibGUiLCJsaWdodFNldHRpbmdzIiwiZ3B1QWdncmVnYXRpb24iLCJHUFVHcmlkTGF5ZXIiLCJpbml0aWFsaXplU3RhdGUiLCJnbCIsImNvbnRleHQiLCJvcHRpb25zIiwiaWQiLCJzaGFkZXJDYWNoZSIsInN0YXRlIiwiZ3B1R3JpZEFnZ3JlZ2F0b3IiLCJ1cGRhdGVTdGF0ZSIsIm9sZFByb3BzIiwicHJvcHMiLCJjaGFuZ2VGbGFncyIsInJlcHJvamVjdE5lZWRlZCIsIm5lZWRzUmVQcm9qZWN0UG9pbnRzIiwiZGF0YUNoYW5nZWQiLCJnZXRMYXllckRhdGEiLCJkYXRhIiwiY2VsbFNpemVNZXRlcnMiLCJjb3VudHNCdWZmZXIiLCJtYXhDb3VudEJ1ZmZlciIsImdyaWRTaXplIiwiZ3JpZE9yaWdpbiIsImdyaWRPZmZzZXQiLCJzZXRTdGF0ZSIsImdldFN1YkxheWVyUHJvcHMiLCJtaW5Db2xvciIsIm1heENvbG9yIiwibGF5ZXJEYXRhIiwibnVtSW5zdGFuY2VzIiwiZ2V0U3ViTGF5ZXJDbGFzcyIsInJlbmRlckxheWVycyIsIlN1YkxheWVyQ2xhc3MiLCJsYXllck5hbWUiXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFD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QkFBVTtBQW5Ca0IsS0FBdkIsQ0FBUDtBQXFCRCxHQTNFc0QsQ0E2RXZEO0FBQ0E7OztBQUNBaUMscUJBQW1CO0FBQ2pCLFdBQU9wRCxnQkFBUDtBQUNEOztBQUVEcUQsaUJBQWU7QUFDYixVQUFNQyxnQkFBZ0IsS0FBS0YsZ0JBQUwsRUFBdEI7QUFFQSxXQUFPLElBQUlFLGFBQUosQ0FBa0IsS0FBS1AsZ0JBQUwsRUFBbEIsQ0FBUDtBQUNEOztBQXZGc0Q7QUEwRnpEekIsYUFBYWlDLFNBQWIsR0FBeUIsV0FBekI7QUFDQWpDLGFBQWFoQixZQUFiLEdBQTRCQSxZQUE1QiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAxNSAtIDIwMTcgVWJlciBUZWNobm9sb2dpZXMsIEluYy5cbi8vXG4vLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4vLyBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4vLyBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4vLyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4vLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbi8vIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4vL1xuLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbi8vIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuLy9cbi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1Jcbi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuLy8gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4vLyBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4vLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuLy8gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxuLy8gVEhFIFNPRlRXQVJFLlxuXG5pbXBvcnQge0NvbXBvc2l0ZUxheWVyfSBmcm9tICdAZGVjay5nbC9jb3JlJztcblxuaW1wb3J0IEdQVUdyaWRDZWxsTGF5ZXIgZnJvbSAnLi9ncHUtZ3JpZC1jZWxsLWxheWVyJztcblxuaW1wb3J0IHtwb2ludFRvRGVuc2l0eUdyaWREYXRhfSBmcm9tICcuL2dwdS1ncmlkLXV0aWxzJztcbmltcG9ydCBHUFVHcmlkQWdncmVnYXRvciBmcm9tICdAZGVjay5nbC9leHBlcmltZW50YWwtbGF5ZXJzL3V0aWxzL2dwdS1ncmlkLWFnZ3JlZ2F0b3InO1xuXG5jb25zdCBNSU5DT0xPUiA9IFswLCAwLCAwLCAyNTVdO1xuY29uc3QgQ1BVX01BWENPTE9SID0gWzI1NSwgMCwgMCwgMjU1XTtcbmNvbnN0IEdQVV9NQVhDT0xPUiA9IFswLCAyNTUsIDAsIDI1NV07XG5cbmNvbnN0IGRlZmF1bHRQcm9wcyA9IHtcbiAgLy8gZWxldmF0aW9uXG4gIGVsZXZhdGlvblNjYWxlOiAxLFxuXG4gIC8vIGdyaWRcbiAgY2VsbFNpemU6IHt0eXBlOiAnbnVtYmVyJywgbWluOiAwLCBtYXg6IDEwMDAsIHZhbHVlOiAxMDAwfSxcbiAgY292ZXJhZ2U6IHt0eXBlOiAnbnVtYmVyJywgbWluOiAwLCBtYXg6IDEsIHZhbHVlOiAxfSxcbiAgZ2V0UG9zaXRpb246IHggPT4geC5wb3NpdGlvbixcbiAgZXh0cnVkZWQ6IGZhbHNlLFxuICBmcDY0OiBmYWxzZSxcbiAgcGlja2FibGU6IGZhbHNlLCAvLyBUT0RPOiBFbmFibGUgcGlja2luZyB3aXRoIEdQVSBBZ2dyZWdhdGlvblxuXG4gIC8vIE9wdGlvbmFsIHNldHRpbmdzIGZvciAnbGlnaHRpbmcnIHNoYWRlciBtb2R1bGVcbiAgbGlnaHRTZXR0aW5nczoge30sXG5cbiAgLy8gR1BVIEFnZ3JlZ2F0aW9uXG4gIGdwdUFnZ3JlZ2F0aW9uOiB0cnVlXG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHUFVHcmlkTGF5ZXIgZXh0ZW5kcyBDb21wb3NpdGVMYXllciB7XG4gIGluaXRpYWxpemVTdGF0ZSgpIHtcbiAgICBjb25zdCB7Z2x9ID0gdGhpcy5jb250ZXh0O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBpZDogYCR7dGhpcy5pZH0tZ3B1LWFnZ3JlZ2F0b3JgLFxuICAgICAgc2hhZGVyQ2FjaGU6IHRoaXMuY29udGV4dC5zaGFkZXJDYWNoZVxuICAgIH07XG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGdwdUdyaWRBZ2dyZWdhdG9yOiBuZXcgR1BVR3JpZEFnZ3JlZ2F0b3IoZ2wsIG9wdGlvbnMpXG4gICAgfTtcbiAgfVxuXG4gIHVwZGF0ZVN0YXRlKHtvbGRQcm9wcywgcHJvcHMsIGNoYW5nZUZsYWdzfSkge1xuICAgIGNvbnN0IHJlcHJvamVjdE5lZWRlZCA9IHRoaXMubmVlZHNSZVByb2plY3RQb2ludHMob2xkUHJvcHMsIHByb3BzKTtcblxuICAgIGlmIChjaGFuZ2VGbGFncy5kYXRhQ2hhbmdlZCB8fCByZXByb2plY3ROZWVkZWQpIHtcbiAgICAgIC8vIHByb2plY3QgZGF0YSBpbnRvIGhleGFnb25zLCBhbmQgZ2V0IHNvcnRlZEJpbnNcbiAgICAgIHRoaXMuZ2V0TGF5ZXJEYXRhKCk7XG4gICAgfVxuICB9XG5cbiAgbmVlZHNSZVByb2plY3RQb2ludHMob2xkUHJvcHMsIHByb3BzKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIG9sZFByb3BzLmNlbGxTaXplICE9PSBwcm9wcy5jZWxsU2l6ZSB8fFxuICAgICAgb2xkUHJvcHMuZ3B1QWdncmVnYXRpb24gIT09IHByb3BzLmdwdUFnZ3JlZ2F0aW9uIHx8XG4gICAgICBvbGRQcm9wcy5nZXRQb3NpdGlvbiAhPT0gcHJvcHMuZ2V0UG9zaXRpb25cbiAgICApO1xuICB9XG5cbiAgZ2V0TGF5ZXJEYXRhKCkge1xuICAgIGNvbnN0IHtkYXRhLCBjZWxsU2l6ZSwgZ2V0UG9zaXRpb24sIGdwdUFnZ3JlZ2F0aW9ufSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3Qge2NvdW50c0J1ZmZlciwgbWF4Q291bnRCdWZmZXIsIGdyaWRTaXplLCBncmlkT3JpZ2luLCBncmlkT2Zmc2V0fSA9IHBvaW50VG9EZW5zaXR5R3JpZERhdGEoXG4gICAgICB7XG4gICAgICAgIGRhdGEsXG4gICAgICAgIGNlbGxTaXplTWV0ZXJzOiBjZWxsU2l6ZSxcbiAgICAgICAgZ2V0UG9zaXRpb24sXG4gICAgICAgIGdwdUFnZ3JlZ2F0aW9uLFxuICAgICAgICBncHVHcmlkQWdncmVnYXRvcjogdGhpcy5zdGF0ZS5ncHVHcmlkQWdncmVnYXRvclxuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLnNldFN0YXRlKHtjb3VudHNCdWZmZXIsIG1heENvdW50QnVmZmVyLCBncmlkU2l6ZSwgZ3JpZE9yaWdpbiwgZ3JpZE9mZnNldH0pO1xuICB9XG5cbiAgLy8gZm9yIHN1YmNsYXNzaW5nLCBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byByZXR1cm5cbiAgLy8gY3VzdG9taXplZCBzdWIgbGF5ZXIgcHJvcHNcbiAgZ2V0U3ViTGF5ZXJQcm9wcygpIHtcbiAgICBjb25zdCB7ZWxldmF0aW9uU2NhbGUsIGZwNjQsIGV4dHJ1ZGVkLCBjZWxsU2l6ZSwgY292ZXJhZ2UsIGxpZ2h0U2V0dGluZ3N9ID0gdGhpcy5wcm9wcztcblxuICAgIGNvbnN0IHtjb3VudHNCdWZmZXIsIG1heENvdW50QnVmZmVyLCBncmlkU2l6ZSwgZ3JpZE9yaWdpbiwgZ3JpZE9mZnNldH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IG1pbkNvbG9yID0gTUlOQ09MT1I7XG4gICAgY29uc3QgbWF4Q29sb3IgPSB0aGlzLnByb3BzLmdwdUFnZ3JlZ2F0aW9uID8gR1BVX01BWENPTE9SIDogQ1BVX01BWENPTE9SO1xuXG4gICAgLy8gcmV0dXJuIHByb3BzIHRvIHRoZSBzdWJsYXllciBjb25zdHJ1Y3RvclxuICAgIHJldHVybiBzdXBlci5nZXRTdWJMYXllclByb3BzKHtcbiAgICAgIGlkOiAnZ3JpZC1jZWxsJyxcbiAgICAgIGRhdGE6IHRoaXMuc3RhdGUubGF5ZXJEYXRhLFxuXG4gICAgICBjb3VudHNCdWZmZXIsXG4gICAgICBtYXhDb3VudEJ1ZmZlcixcbiAgICAgIGdyaWRTaXplLFxuICAgICAgZ3JpZE9yaWdpbixcbiAgICAgIGdyaWRPZmZzZXQsXG4gICAgICBudW1JbnN0YW5jZXM6IGdyaWRTaXplWzBdICogZ3JpZFNpemVbMV0sXG4gICAgICBtaW5Db2xvcixcbiAgICAgIG1heENvbG9yLFxuXG4gICAgICBmcDY0LFxuICAgICAgY2VsbFNpemUsXG4gICAgICBjb3ZlcmFnZSxcbiAgICAgIGxpZ2h0U2V0dGluZ3MsXG4gICAgICBlbGV2YXRpb25TY2FsZSxcbiAgICAgIGV4dHJ1ZGVkLFxuICAgICAgcGlja2FibGU6IGZhbHNlXG4gICAgfSk7XG4gIH1cblxuICAvLyBmb3Igc3ViY2xhc3NpbmcsIG92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHJldHVyblxuICAvLyBjdXN0b21pemVkIHN1YiBsYXllciBjbGFzc1xuICBnZXRTdWJMYXllckNsYXNzKCkge1xuICAgIHJldHVybiBHUFVHcmlkQ2VsbExheWVyO1xuICB9XG5cbiAgcmVuZGVyTGF5ZXJzKCkge1xuICAgIGNvbnN0IFN1YkxheWVyQ2xhc3MgPSB0aGlzLmdldFN1YkxheWVyQ2xhc3MoKTtcblxuICAgIHJldHVybiBuZXcgU3ViTGF5ZXJDbGFzcyh0aGlzLmdldFN1YkxheWVyUHJvcHMoKSk7XG4gIH1cbn1cblxuR1BVR3JpZExheWVyLmxheWVyTmFtZSA9ICdHcmlkTGF5ZXInO1xuR1BVR3JpZExheWVyLmRlZmF1bHRQcm9wcyA9IGRlZmF1bHRQcm9wcztcbiJdfQ==